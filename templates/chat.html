<!-- templates/chat.html -->
{% extends "base.html" %}
{% block title %}General Chat | Unknown Gods{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <aside class="chat-sidebar">
        <h3>Online Users</h3>
        <ul id="online-users">
            {% for user in online_users %}
                <li>@{{ user.nickname }}</li>
            {% endfor %}
        </ul>
        <div class="voice-controls" style="display: none;">
            <h4>Voice Chat</h4>
            <button id="join-voice">üéß Join</button>
            <button id="toggle-mic">üéôÔ∏è Mute</button>
            <audio id="voice-audio" autoplay></audio>
        </div>
    </aside>

    <section class="chat-room">
        <div id="chat-box">
            {% for msg in messages %}
                <div class="msg-line"><strong>@{{ msg.sender.nickname }}:</strong> {{ msg.content }}</div>
            {% endfor %}
        </div>
        <form id="chat-form">
            <input type="text" id="chat-input" placeholder="Type a message... use @nickname to tag" autocomplete="off" required>
            <button type="submit">Send</button>
        </form>
    </section>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();

    // Join the chat room
    socket.emit('join', {
        room: 'general',
        user: "{{ user.nickname }}"
    });

    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (chatInput.value.trim()) {
            socket.emit('send_message', {
                room: 'general',
                user: "{{ user.nickname }}",
                message: chatInput.value
            });
            chatInput.value = '';
        }
    });

    socket.on('receive_message', function(data) {
        const msg = document.createElement('div');
        msg.classList.add('msg-line');
        msg.innerHTML = `<strong>@${data.user}:</strong> ${data.message}`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Voice chat UI logic
    socket.on('voice_started', () => {
        document.querySelector('.voice-controls').style.display = 'block';
    });

    document.getElementById('join-voice').addEventListener('click', () => {
        socket.emit('join_voice', { user: "{{ user.nickname }}" });
    });

    document.getElementById('toggle-mic').addEventListener('click', () => {
        socket.emit('mute_voice', { user: "{{ user.nickname }}" });
    });
</script>
<script src="{{ url_for('static', filename='js/audio.js') }}"></script>
{% endblock %}
